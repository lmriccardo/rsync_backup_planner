name: Release on tag push

on:
  push:
    tags:
      - "*"

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest

    environment:
      name: pypi
      url: https://pypi.org/p/backupctl

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag is on main
        run: |
          set -euo pipefail
          git fetch origin main --prune --tags
          tag_commit="$(git rev-parse "${GITHUB_SHA}^{commit}")"
          if git merge-base --is-ancestor "$tag_commit" "origin/main"; then
            echo "Tag commit is on main."
          else
            echo "Tag commit is not on main. Refusing to release." >&2
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install build tooling
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y dpkg-dev
          python -m pip install -U pip build

      - name: Validate tag matches package version
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, re, sys
          from pathlib import Path

          tag = os.environ["GITHUB_REF_NAME"]  # e.g. v0.4.2 or 0.4.2
          pyproject = Path("pyproject.toml").read_text(encoding="utf-8")

          m = re.search(r'(?m)^\s*version\s*=\s*"([^"]+)"\s*$', pyproject)
          if not m:
            print("ERROR: could not find [project].version in pyproject.toml", file=sys.stderr)
            sys.exit(1)

          version = m.group(1)
          normalized_tag = tag[1:] if tag.startswith("v") else tag

          if normalized_tag != version:
            print(f"ERROR: tag '{tag}' does not match pyproject version '{version}'", file=sys.stderr)
            sys.exit(1)

          print(f"OK: tag '{tag}' matches version '{version}'")
          PY

      - name: Build binary via install.sh
        run: |
          set -euo pipefail
          chmod +x ./install.sh
          SKIP_VERIFY=1 ./install.sh --user

          if [ ! -f dist/backupctl ]; then
            echo "Built binary not found at dist/backupctl" >&2
            ls -la dist || true
            exit 1
          fi

          mkdir -p release
          mv dist/backupctl "release/backupctl-${GITHUB_REF_NAME}-linux-x86_64"
        
      - name: Build wheel (source of truth artifact)
        run: |
          set -euo pipefail
          python -m build
          ls -la dist

      - name: Ensure requirements.lock exists
        run: |
          set -euo pipefail
          if [ ! -f requirements.lock ]; then
            echo "requirements.lock not found. Commit it to the repo for reproducible .deb builds." >&2
            exit 1
          fi

      - name: Build .deb (vendored Python deps)
        run: |
          set -euo pipefail

          sudo apt-get update
          sudo apt-get install -y --no-install-recommends dpkg-dev

          version="${GITHUB_REF_NAME#v}"

          deb_root="deb_pkg"
          out_dir="release"
          deb_out="${out_dir}/backupctl_${version}_all.deb"

          rm -rf "$deb_root"
          mkdir -p \
            "$deb_root/DEBIAN" \
            "$deb_root/usr/lib/backupctl" \
            "$deb_root/usr/bin"

          # Vendor: install your wheel + pinned deps into /usr/lib/backupctl
          python -m pip install --no-compile --target "$deb_root/usr/lib/backupctl" dist/*.whl
          python -m pip install --no-compile --target "$deb_root/usr/lib/backupctl" -r requirements.lock

          # Wrapper: requires src/backupctl/__main__.py so `python -m backupctl` works
          cat > "$deb_root/usr/bin/backupctl" <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          export PYTHONPATH="/usr/lib/backupctl${PYTHONPATH:+:$PYTHONPATH}"
          exec /usr/bin/python3 -m backupctl "$@"
          EOF
          chmod 0755 "$deb_root/usr/bin/backupctl"

          # Minimal control file (private repo style; deps are vendored)
          cat > "$deb_root/DEBIAN/control" <<EOF
          Package: backupctl
          Version: ${version}
          Section: utils
          Priority: optional
          Architecture: all
          Maintainer: lmriccardo <rlmarca.dev@gmail.com>
          Depends: python3 (>= 3.12), rsync
          Description: Declarative rsync-based backup automation tool
           backupctl generates and manages rsync backup jobs.
          EOF

          mkdir -p "$out_dir"
          dpkg-deb --root-owner-group --build "$deb_root" "$deb_out"
          ls -lah "$deb_out"


      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            release/backupctl-${{ github.ref_name }}-linux-x86_64
            release/*.deb
            dist/*

      - name: Publish to PyPI (Trusted Publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
