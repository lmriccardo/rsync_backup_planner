name: Release on tag push

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    # Put the secret into env so it can be safely checked in `if:`
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag is on main
        run: |
          set -euo pipefail
          git fetch origin main --prune --tags
          tag_commit="$(git rev-parse "${GITHUB_SHA}^{commit}")"
          if git merge-base --is-ancestor "$tag_commit" "origin/main"; then
            echo "Tag commit is on main."
          else
            echo "Tag commit is not on main. Refusing to release." >&2
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build binary via install.sh
        run: |
          set -euo pipefail
          chmod +x ./install.sh
          SKIP_VERIFY=1 ./install.sh --user
          if [ ! -f dist/backupctl ]; then
            echo "Built binary not found at dist/backupctl" >&2
            exit 1
          fi
          mv dist/backupctl "dist/backupctl-${GITHUB_REF_NAME}-linux-x86_64"

      - name: Collect changelog
        id: changelog
        run: |
          set -euo pipefail
          tag_commit="$(git rev-parse "${GITHUB_SHA}^{commit}")"
          prev_tag="$(git describe --tags --abbrev=0 "${tag_commit}^" 2>/dev/null || true)"
          if [ -n "$prev_tag" ]; then
            range="${prev_tag}..${tag_commit}"
          else
            range="${tag_commit}"
          fi
          git log --no-merges -n 100 --pretty=format:"- %s (%h)" $range > /tmp/changes.txt
          if [ ! -s /tmp/changes.txt ]; then
            echo "No changes listed." > /tmp/changes.txt
          fi
          delimiter="CHANGELOG_$(date +%s%N)"
          {
            printf "changes<<%s\n" "$delimiter"
            cat /tmp/changes.txt
            printf "\n%s\n" "$delimiter"
          } >> "$GITHUB_OUTPUT"

      - name: Summarize changes with Codex
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          model: gpt-5.2-codex
          prompt: |
            Create release notes for tag "${{ github.ref_name }}".

            Requirements:
            - 3-6 concise bullet points
            - Focus on user-visible changes
            - No headings, no intro, just bullets

            Changes since previous tag:
            ${{ steps.changelog.outputs.changes }}

      - name: Prepare release notes
        id: release_notes
        env:
          CODEX_TEXT: ${{ steps.run_codex.outputs.final-message }}
          CHANGELOG: ${{ steps.changelog.outputs.changes }}
        run: |
          set -euo pipefail
          if [ -n "${CODEX_TEXT:-}" ]; then
            body="$CODEX_TEXT"
          else
            body="$CHANGELOG"
          fi
          delimiter="BODY_$(date +%s%N)"
          {
            printf "body<<%s\n" "$delimiter"
            printf "%s\n" "$body"
            printf "\n%s\n" "$delimiter"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: ${{ steps.release_notes.outputs.body }}
          files: dist/backupctl-${{ github.ref_name }}-linux-x86_64
