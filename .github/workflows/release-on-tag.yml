name: Release on tag push

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag is on main
        run: |
          set -euo pipefail
          git fetch origin main --prune --tags
          tag_commit="$(git rev-parse "${GITHUB_SHA}^{commit}")"
          if git merge-base --is-ancestor "$tag_commit" "origin/main"; then
            echo "Tag commit is on main."
          else
            echo "Tag commit is not on main. Refusing to release." >&2
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build binary via install.sh
        run: |
          set -euo pipefail
          chmod +x ./install.sh
          ./install.sh --user
          mv dist/backupctl "dist/backupctl-${GITHUB_REF_NAME}-linux-x86_64"

      - name: Collect changelog
        id: changelog
        run: |
          set -euo pipefail
          tag_commit="$(git rev-parse "${GITHUB_SHA}^{commit}")"
          prev_tag="$(git describe --tags --abbrev=0 "${tag_commit}^" 2>/dev/null || true)"
          if [ -n "$prev_tag" ]; then
            range="${prev_tag}..${tag_commit}"
          else
            range="${tag_commit}"
          fi
          git log --no-merges --pretty=format:"- %s (%h)" $range > /tmp/changes.txt
          printf "changes<<'EOF'\n%s\nEOF\n" "$(cat /tmp/changes.txt)" >> "$GITHUB_OUTPUT"

      - name: Summarize changes with Codex
        id: codex_summary
        uses: openai/codex-action@v1
        with:
          prompt: |
            Provide a short release summary (3-6 bullets) based on the changes below.
          input: ${{ steps.changelog.outputs.changes }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Prepare release notes
        id: release_notes
        env:
          CODEX_TEXT: ${{ steps.codex_summary.outputs.text }}
          CHANGELOG: ${{ steps.changelog.outputs.changes }}
        run: |
          set -euo pipefail
          if [ -n "$CODEX_TEXT" ]; then
            printf "body<<'EOF'\n%s\nEOF\n" "$CODEX_TEXT" >> "$GITHUB_OUTPUT"
          else
            printf "body<<'EOF'\n%s\nEOF\n" "$CHANGELOG" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: ${{ steps.release_notes.outputs.body }}
          files: dist/backupctl-${{ github.ref_name }}-linux-x86_64
