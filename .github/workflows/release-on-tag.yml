name: Release on tag push

on:
  push:
    tags:
      - "*"

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest

    environment:
      name: pypi
      url: https://pypi.org/p/backupctl

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag is on main
        run: |
          set -euo pipefail
          git fetch origin main --prune --tags
          tag_commit="$(git rev-parse "${GITHUB_SHA}^{commit}")"
          if git merge-base --is-ancestor "$tag_commit" "origin/main"; then
            echo "Tag commit is on main."
          else
            echo "Tag commit is not on main. Refusing to release." >&2
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install build tooling
        run: |
          set -euo pipefail
          python -m pip install -U pip build

      - name: Validate tag matches package version
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, re, sys
          from pathlib import Path

          tag = os.environ["GITHUB_REF_NAME"]  # e.g. v0.4.2 or 0.4.2
          pyproject = Path("pyproject.toml").read_text(encoding="utf-8")

          m = re.search(r'(?m)^\s*version\s*=\s*"([^"]+)"\s*$', pyproject)
          if not m:
            print("ERROR: could not find [project].version in pyproject.toml", file=sys.stderr)
            sys.exit(1)

          version = m.group(1)
          normalized_tag = tag[1:] if tag.startswith("v") else tag

          if normalized_tag != version:
            print(f"ERROR: tag '{tag}' does not match pyproject version '{version}'", file=sys.stderr)
            sys.exit(1)

          print(f"OK: tag '{tag}' matches version '{version}'")
          PY

      - name: Build binary via install.sh
        run: |
          set -euo pipefail
          chmod +x ./install.sh
          SKIP_VERIFY=1 ./install.sh --user

          if [ ! -f dist/backupctl ]; then
            echo "Built binary not found at dist/backupctl" >&2
            ls -la dist || true
            exit 1
          fi

          mkdir -p release
          mv dist/backupctl "release/backupctl-${GITHUB_REF_NAME}-linux-x86_64"
        
      - name: Build package (sdist + wheel)
        run: |
          set -euo pipefail
          python -m build
          ls -la dist

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            release/backupctl-${{ github.ref_name }}-linux-x86_64
            dist/*

      - name: Publish to PyPI (Trusted Publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
